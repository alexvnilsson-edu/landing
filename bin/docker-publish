#!/bin/bash
set -e
trap 'last_command=$current_command; current_command=$BASH_COMMAND' DEBUG
trap 'echo "\"${last_command}\" command filed with exit code $?."' EXIT

tmp_id=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 13 ; echo '')
tmp="tmp_${tmp_id}"
mkdir $tmp

LOG_FILE="${tmp}/log.txt"

azure_cr_postfix=azurecr.io

if [[ -f .env ]]; then
    echo "Reading variables from .env file..."
    source .env
else
    echo "No .env found."
    echo "Do not forget to set-up GihHub secrets!"
fi

iname=${IMAGE_NAME:-image}
iversion=${IMAGE_VERSION:-latest}

idig="" # empty on purpose

if [[ ! -z "${CONTAINER_REGISTER_URL}" ]]; then
    echo "Tagging $iname:$iversion at $CONTAINER_REGISTER_URL..."
    echo $(docker tag $iname $CONTAINER_REGISTER_URL/$iname:$iversion)
else
    echo "Tagging $iname:$iversion..."
    echo $(docker tag $iname $iname:$iversion)
fi

if [[ ! -z "${CONTAINER_REGISTER_URL}" ]]; then
    DP_LOG_FILE="${tmp}/docker-push.log"

    echo "Pushing $iname:$iversion to $CONTAINER_REGISTER_URL..."
    docker push $CONTAINER_REGISTER_URL/$iname:$iversion | tee $DP_LOG_FILE

    idig=$(${BASH_SOURCE%/*}/acr-helpers/get-deploy-digest $DP_LOG_FILE)

    echo "${idig}"
else
    echo "Pushing $iname:$iversion..."
    
    docker push $iname:$iversion
fi

bin/docker-postpublish $tmp $idig

rm -rf "${tmp}/"

echo "Done."

